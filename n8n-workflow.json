{
  "name": "Railway Permit-to-Work Enterprise Automation",
  "nodes": [
    {
      "name": "Form Submission Trigger",
      "type": "n8n-nodes-base.webhook",
      "position": [100, 300],
      "parameters": {
        "path": "submit-permit",
        "options": {}
      }
    },
    {
      "name": "Validate Contractor & Worker",
      "type": "n8n-nodes-base.airtable",
      "position": [300, 300],
      "parameters": {
        "operation": "list",
        "baseId": "appRailwayBase",
        "table": "Contractors",
        "filterByFormula": "={Company}='{{$json.body.contractor}}'"
      }
    },
    {
      "name": "Compliance Check",
      "type": "n8n-nodes-base.if",
      "position": [500, 300],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.fields.Active}}",
              "value2": true
            }
          ]
        }
      }
    },
    {
      "name": "Initialize Permit Record",
      "type": "n8n-nodes-base.airtable",
      "position": [700, 200],
      "parameters": {
        "operation": "create",
        "baseId": "appRailwayBase",
        "table": "Permits",
        "fields": {
          "values": {
            "string": [
              { "name": "Status", "value": "Pending Supervisor" },
              { "name": "Worker", "value": "={{$node[\"Form Submission Trigger\"].json.body.workerName}}" }
            ]
          }
        }
      }
    },
    {
      "name": "Notify Supervisor (Slack)",
      "type": "n8n-nodes-base.slack",
      "position": [900, 200],
      "parameters": {
        "resource": "message",
        "text": "=üöß *Permit Approval Required*\nWorker: {{$node[\"Form Submission Trigger\"].json.body.workerName}}\nType: {{$node[\"Form Submission Trigger\"].json.body.workType}}\n\n<https://n8n.your-domain.com/webhook/approve-permit?id={{$json.id}}&role=supervisor|Approve> | <https://n8n.your-domain.com/webhook/reject-permit?id={{$json.id}}|Reject>"
      }
    },
    {
      "name": "Approval Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [100, 600],
      "parameters": {
        "path": "approve-permit",
        "options": {}
      }
    },
    {
      "name": "Update Status: Approved",
      "type": "n8n-nodes-base.airtable",
      "position": [300, 600],
      "parameters": {
        "operation": "update",
        "baseId": "appRailwayBase",
        "table": "Permits",
        "id": "={{$json.query.id}}",
        "fields": { "values": { "string": [{ "name": "Status", "value": "Approved" }] } }
      }
    },
    {
      "name": "Generate QR Code",
      "type": "n8n-nodes-base.httpRequest",
      "position": [500, 600],
      "parameters": {
        "url": "=https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{$json.id}}",
        "responseFormat": "file"
      }
    },
    {
      "name": "Generate PDF Permit",
      "type": "n8n-nodes-base.htmlToPdf",
      "position": [700, 600],
      "parameters": {
        "html": "<h1>Railway Permit Issued</h1><p>Permit ID: {{$node[\"Update Status: Approved\"].json.id}}</p>"
      }
    },
    {
      "name": "Send Digital Permit (SMS)",
      "type": "n8n-nodes-base.twilio",
      "position": [900, 600],
      "parameters": {
        "message": "Your railway permit has been issued. Download here: {{$node[\"Generate PDF Permit\"].json.url}}"
      }
    },
    {
      "name": "On Error: Notify Admin",
      "type": "n8n-nodes-base.errorTrigger",
      "position": [100, 900],
      "parameters": {}
    },
    {
      "name": "Slack Alert: System Error",
      "type": "n8n-nodes-base.slack",
      "position": [300, 900],
      "parameters": {
        "text": "‚ùå *Workflow Error in Permit System*\nNode: {{$json.execution.errorNode.name}}\nMessage: {{$json.execution.error.message}}"
      }
    }
  ],
  "connections": {
    "Form Submission Trigger": { "main": [[{ "node": "Validate Contractor & Worker", "type": "main", "index": 0 }]] },
    "Validate Contractor & Worker": { "main": [[{ "node": "Compliance Check", "type": "main", "index": 0 }]] },
    "Compliance Check": { "main": [[{ "node": "Initialize Permit Record", "type": "main", "index": 0 }]] },
    "Initialize Permit Record": { "main": [[{ "node": "Notify Supervisor (Slack)", "type": "main", "index": 0 }]] },
    "Approval Webhook": { "main": [[{ "node": "Update Status: Approved", "type": "main", "index": 0 }]] },
    "Update Status: Approved": { "main": [[{ "node": "Generate QR Code", "type": "main", "index": 0 }]] },
    "Generate QR Code": { "main": [[{ "node": "Generate PDF Permit", "type": "main", "index": 0 }]] },
    "Generate PDF Permit": { "main": [[{ "node": "Send Digital Permit (SMS)", "type": "main", "index": 0 }]] },
    "On Error: Notify Admin": { "main": [[{ "node": "Slack Alert: System Error", "type": "main", "index": 0 }]] }
  }
}
